// Dummy user data for fallback
if (typeof users === "undefined") {
  const users = [
    {
      referenceNumber: "ABCD1234",
      otp: "123456",
      pdf: "../../images/pdfs/abcd1234.pdf",
    },
    {
      referenceNumber: "EFGH5678",
      otp: "654321",
      pdf: "../../images/pdfs/efgh5678.pdf",
    },
  ];
}

let currentUser = null;

// Generate a 6-character random captcha
function generateCaptcha() {
  const characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let captcha = "";
  for (let i = 0; i < 6; i++) {
    captcha += characters.charAt(Math.floor(Math.random() * characters.length));
  }
  generatedCaptcha = captcha;
  displayCaptcha();
}

// Display the captcha in the UI
function displayCaptcha() {
  const captchaElement = document.getElementById("captchaimg");
  if (captchaElement) {
    captchaElement.innerText = generatedCaptcha;
  }
}

// Refresh the captcha
function refreshCaptcha() {
  generateCaptcha();
}

// Validate the captcha input
function validateCaptchaInput() {
  const userInput = document.getElementById("vpb_captcha_code").value.trim();
  if (userInput === generatedCaptcha) {
    return true;
  } else {
    alert("Invalid captcha. Please try again.");
    refreshCaptcha();
    return false;
  }
}

// Handle "NEXT" button click
function handleReferenceSubmission() {
  const referenceNumber = document.getElementById("reference_numb").value.trim();
  currentUser = users.find((user) => user.referenceNumber === referenceNumber);

  if (!currentUser) {
    alert("Invalid reference number. Please try again.");
    return;
  }

  if (!validateCaptchaInput()) {
    return;
  }

  document.getElementById("reference-section").style.display = "none";
  document.getElementById("otp-section").style.display = "block";
}

// Handle "VALIDATE OTP" button click
function handleOtpValidation() {
  const otpInput = document.getElementById("otp_input").value.trim();

  if (otpInput === currentUser.otp) {
    alert("OTP validated successfully!");
    extractPdfText(currentUser.pdf);
  } else {
    alert("Invalid OTP. Please try again.");
  }
}

// Extract text from PDF using PDF.js
function extractPdfText(pdfUrl) {
  const loadingTask = pdfjsLib.getDocument(pdfUrl);

  loadingTask.promise
    .then((pdf) => pdf.getPage(1))
    .then((page) => page.getTextContent())
    .then((textContent) => {
      const extractedText = textContent.items.map((item) => item.str).join(" ");
      renderUserInfo(parsePdfData(extractedText));
    })
    .catch((error) => {
      console.error("Failed to extract text from PDF:", error);
      alert("Failed to extract data from PDF. Falling back to static data.");
      renderUserInfo(null); // Fallback to static data
    });
}

// Parse the extracted PDF data into a structured format
function parsePdfData(extractedText) {
  // Example of parsing logic
  // Adjust based on your actual PDF structure
  return {
    fullName: "John Doe",
    dob: "01-01-1990",
    citizenship: "Bangladesh",
    passportNumber: "A12345678",
    visaNumber: "54639017",
    visaType: "Tourist",
    validityPeriod: "01-01-2024 to 31-12-2024",
    periodOfStay: "60 days",
    numberOfEntries: "Single",
    invitation: "Example Organization",
    dateOfVisa: "25-12-2023",
  };
}

// Render user information dynamically
function renderUserInfo(data) {
  const userInfo = document.getElementById("user-info");

  if (!data) {
    // Fallback to static data if parsing fails
    data = {
      fullName: "John Doe",
      dob: "01-01-1990",
      citizenship: "Bangladesh",
      passportNumber: "A12345678",
      visaNumber: "54639017",
      visaType: "Tourist",
      validityPeriod: "01-01-2024 to 31-12-2024",
      periodOfStay: "60 days",
      numberOfEntries: "Single",
      invitation: "Example Organization",
      dateOfVisa: "25-12-2023",
    };
  }

  userInfo.innerHTML = `
    <center>
      <div><button onClick="window.print();">Print</button></div>
      <table width="800" cellpadding="2" cellspacing="2" style="border-bottom:2px solid black;">
        <tr>
          <td align="left"><img src="../images/img/logo_3.png" width="90" /></td>
          <td align="left" style="font-size: 17px; line-height: 22px;">
            <p align="center"><b>MINISTRY OF FOREIGN AFFAIRS OF THE KYRGYZ REPUBLIC</b></p>
            <p align="center">Электрондук виза – «E-visa»</p>
          </td>
        </tr>
      </table>
      <table width="800" cellpadding="2" cellspacing="2">
        <tr>
          <td><b>Full Name:</b></td>
          <td>${data.fullName}</td>
        </tr>
        <tr>
          <td><b>Date of Birth:</b></td>
          <td>${data.dob}</td>
        </tr>
        <tr>
          <td><b>Citizenship:</b></td>
          <td>${data.citizenship}</td>
        </tr>
        <tr>
          <td><b>Passport Number:</b></td>
          <td>${data.passportNumber}</td>
        </tr>
        <tr>
          <td><b>Visa Number:</b></td>
          <td>${data.visaNumber}</td>
        </tr>
        <tr>
          <td><b>Visa Type:</b></td>
          <td>${data.visaType}</td>
        </tr>
        <tr>
          <td><b>Validity Period:</b></td>
          <td>${data.validityPeriod}</td>
        </tr>
        <tr>
          <td><b>Period of Stay:</b></td>
          <td>${data.periodOfStay}</td>
        </tr>
        <tr>
          <td><b>Number of Entries:</b></td>
          <td>${data.numberOfEntries}</td>
        </tr>
        <tr>
          <td><b>Invitation:</b></td>
          <td>${data.invitation}</td>
        </tr>
        <tr>
          <td><b>Date of Visa:</b></td>
          <td>${data.dateOfVisa}</td>
        </tr>
      </table>
    </center>
  `;

  userInfo.style.display = "block";
}

// Handle "SEND ME SECURITY CODE BY EMAIL" button click
function sendSecurityCodeByEmail() {
  showModal();
}

// Show the modal
function showModal() {
  const modal = document.getElementById("email-notification-modal");
  if (modal) {
    modal.style.display = "block";
  }
}

// Close the modal
function closeModal() {
  const modal = document.getElementById("email-notification-modal");
  if (modal) {
    modal.style.display = "none";
  }
}

// Attach event listeners
document.addEventListener("DOMContentLoaded", () => {
  generateCaptcha();

  document.getElementById("btn_next").addEventListener("click", handleReferenceSubmission);
  document.getElementById("btn_validate_otp").addEventListener("click", handleOtpValidation);
  document.getElementById("btn_send_code").addEventListener("click", sendSecurityCodeByEmail);
  document.querySelector(".modal-dialog-close").addEventListener("click", closeModal);
  document.querySelector(".modal-dialog-ok").addEventListener("click", closeModal);
});
